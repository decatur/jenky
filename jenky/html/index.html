<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jenky</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 2em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, td, th {
            border: 1px solid black;
        }

        td, th {
            padding: 1ex;
        }

        fieldset {
            margin-top: 1em;
        }

        .grid-container {
            margin-top: 1ex;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 0 1em;
        }

    </style>
</head>
<body>
<h1>Jenky 0.0.2, the gentle deploying app for Python</h1>
<table>
    <thead>
    <tr>
        <th>Repo Name</th>
        <th>Git Actions</th>
        <th>Process Name</th>
        <th>Start/Stop Time</th>
        <th>Action</th>
        <th>Logs</th>
    </tr>
    </thead>
    <tbody id="repos"></tbody>
</table>

<template id="processRow">
    <tr>
        <td>Repo Name...</td>
        <td><label><input type="radio" name="process"></label></td>
        <td>Process Name...</td>
        <td>Start/Stop Time...</td>
        <td>
            <label style="display: inline-block"><input type="radio" name="status" value="start">Start</label>
            <label style="display: inline-block"><input type="radio" name="status" value="transition" disabled>Provisioning</label>
            <label style="display: inline-block"><input type="radio" name="status" value="stop">Stop</label>
        </td>
        <td>
            <a href="" target="">stdout</a>
            <!-- <a href="" target="">stderr</a> -->
        </td>
    </tr>
</template>

<fieldset>
    <legend>Git Actions</legend>
    <form>
        <div>
            <button id="fetch" type="button">Fetch â­¯</button>
            <button id="checkout" type="button">checkout</button>
            <code id="repoName"></code> current tag is <code id="gitTag"></code>
        </div>
        <div class="grid-container">
            <div>
                <label for="checkoutSrc"></label>
                <select id="checkoutSrc" size=20>
                    <optgroup id="gitTags" label="Tags"></optgroup>
                    <optgroup id="gitBranches" label="Branches"></optgroup>
                </select>

            </div>
            <div id="gitMessage" style="background-color: azure;"></div>
        </div>
    </form>
</fieldset>

</body>
<script type="module">
    /** @type{jenky.Repo[]} */
    let repos;
    /** @type{jenky.RepoDict } */
    let reposByName;

    /**
     */
    function renderRepos() {
        const tbody = document.getElementById('repos');
        tbody.textContent = '';
        const template = document.getElementById('processRow');
        for (const repo of repos) {
            const name = repo.repoName;
            for (const proc of repo.processes) {
                let tr = template.content.firstElementChild.cloneNode(true);
                let td = tr.firstElementChild;
                td.textContent = repo.repoName;

                td = td.nextElementSibling;
                td.firstElementChild.value = repo.repoName;
                td.firstElementChild.addEventListener('change', () => {
                    fetchRepo(name)
                        .then(repo => {
                            reposByName[name] = repo;
                            renderRepo(name);
                        })
                });

                td = td.nextElementSibling;
                td.textContent = proc.name;

                td = td.nextElementSibling;
                td.textContent = proc.createTime ? new Date(proc.createTime * 1000).toISOString() : '';

                td = td.nextElementSibling;   // Status
                let transition;
                for (const input of td.querySelectorAll('input')) {
                    if (input.value === 'start') input.checked = proc.running;
                    else if (input.value === 'stop') input.checked = !proc.running;
                    else transition = input;
                    input.addEventListener('change', (evt) => {
                        const targetValue = evt.target.value;
                        transition.checked = true;
                        if (targetValue === 'stop') {
                            kill(evt, repo, proc);
                        } else if (targetValue === 'start') {
                            restart(evt, repo, proc);
                        } else {
                            console.assert(false)
                        }
                    });
                }

                // /repos/{repo_id}/processes/{process_id}/{std}
                td = td.nextElementSibling;
                let a = td.firstElementChild;
                while (a) {
                    const std = a.textContent;
                    a.href = `/repos/${name}/processes/${proc.name}/${std}`;
                    a.target = `${proc.name}_${std}`;
                    a = a.nextElementSibling;
                }

                tbody.appendChild(tr);
            }
        }
    }

    /**
     * @param {string} repoName
     */
    function renderRepo(repoName) {
        /** @type{HTMLSelectElement} */
        const select = /** @type{HTMLSelectElement} */ document.getElementById('checkoutSrc');
        /** @type{jenky.Repo} */
        const repo = reposByName[repoName];
        // document.getElementById('checkout').disabled = !repo.gitTag;
        select.oninput = evt => console.log(evt);
        document.getElementById('fetch').onclick = () => gitFetch(repoName);
        document.getElementById('checkout').onclick = () => checkout(repoName, select.value);
        document.getElementById('repoName').textContent = repoName;
        document.getElementById('gitTag').textContent = (repo.gitTag ? repo.gitTag : repo.gitMessage);
        document.getElementById('gitMessage').textContent = "";

        let optGroup = document.getElementById('gitTags');
        optGroup.textContent = '';
        for (const tag of repo.gitTags) {
            const option = document.createElement('option');
            option.textContent = tag.join(' ');
            option.value = 'tags/' + tag[1];
            optGroup.appendChild(option);
        }

        optGroup = document.getElementById('gitBranches');
        optGroup.textContent = '';
        for (const branch of repo.gitBranches) {
            const option = document.createElement('option');
            option.textContent = branch.join(' ');
            option.value = branch[1];
            optGroup.appendChild(option);
        }

    }

    /**
     * @param {jenky.Repo} data
     */
    function setRepos(data) {
        repos = /** @type{jenky.Repo[]} */ data;
        reposByName = {};
        for (const repo of repos) {
            reposByName[repo.repoName] = repo;
        }
    }

    /**
     * @param {Event} evt
     * @param {jenky.Repo} repo
     * @param {jenky.Process} proc
     */
    function kill(evt, repo, proc) {
        evt.target.disabled = true;
        postAction(repo, proc, 'kill');
    }

    /**
     * @param {Event} evt
     * @param {jenky.Repo} repo
     * @param {jenky.Process} proc
     */
    function restart(evt, repo, proc) {
        evt.target.disabled = true;
        postAction(repo, proc, 'restart');
    }

    function gitFetch(repoName) {
        const payload = {action: 'fetch'};
        const msgElem = document.getElementById('gitMessage');
        msgElem.textContent = 'Loading...';
        fetch(`/repos/${repoName}`, {method: 'post', body: JSON.stringify(payload)})
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    msgElem.textContent = (response.statusText + ' ' + response.url);
                }
            })
            .then(data => {
                /** @type{jenky.Repo} */
                const repo = /** @type{jenky.Repo} */ (data);
                reposByName[repo.repoName] = repo;
                renderRepo(repo.repoName);
                msgElem.textContent = repo.gitMessage
            })
    }

    function checkout(repoName, gitTag) {
        const payload = {action: 'checkout', gitTag: gitTag};
        const msgElem = document.getElementById('gitMessage');
        msgElem.textContent = 'Loading...';
        fetch(`/repos/${repoName}`, {method: 'post', body: JSON.stringify(payload)})
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    msgElem.textContent = (response.statusText + ' ' + response.url);
                }
            })
            .then(data => msgElem.textContent = data['message'])
    }

    function fetchRepo(repoName) {
        return fetch(`/repos/${repoName}`)
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    alert(response.statusText + ' ' + response.url);
                }
            })
    }

    /**
     * @param {jenky.Repo} repo
     * @param {jenky.Process} proc
     * @param {string} action
     */
    function postAction(repo, proc, action) {
        const payload = {action: action};
        fetch(`/repos/${repo.repoName}/processes/${proc.name}`, {method: 'post', body: JSON.stringify(payload)})
            .then(response => {
                if (response.status === 200) {
                    return response.json();
                } else {
                    console.log(response.statusText + ' ' + response.url);
                    response.text().then(text => alert(text))
                }
            })
            .then(data => console.log(data))
            .then(fetchRepos)
    }


    function fetchRepos() {
        fetch('/repos')
            .then(response => response.json())
            .then(data => {
                setRepos(data['repos']);
                renderRepos();
            })
    }

    fetchRepos()
</script>
</html>
